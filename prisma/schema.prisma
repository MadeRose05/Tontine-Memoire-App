generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Model
model User {
  id             String    @id @default(uuid())
  msisdn         String    @unique
  pin            String
  name           String
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  tempOTP        TempOTP?
  createdTontine Tontine[]
  Bank           Bank?
  Profile        Profile?

  Participants Participants[]

  Invitation Invitation[]
}

enum Role {
  USER
  ADMIN
  SUPER_ADMIN
}

enum Status {
  ACTIVE
  BANNED
  DELETED
}

model Bank {
  id        String   @id @default(uuid())
  firstName String
  lastName  String
  balance   Float    @default(0.0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String   @unique
}

model Profile {
  id        String   @id @default(uuid())
  username  String   @unique @db.VarChar(20)
  image     String?
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String   @unique
  about     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TempOTP {
  id        String   @id @default(uuid())
  user      User     @relation(fields: [msisdn], references: [msisdn], onDelete: Cascade)
  msisdn    String   @unique
  otp       Int
  createdAt DateTime @default(now())
}

model Participants {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tontine   Tontine  @relation(fields: [tontineId], references: [id])
  tontineId String
  userId    String
  round     Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  Transaction Transaction[]
}

// Pool Model
model Tontine {
  id           String         @id @default(uuid())
  nom          String
  description  String?
  cotisation   Int
  status       TontineStatus  @default(Pending)
  totalRound   Int
  frequence    Frequence      @default(Month)
  startDate    String?
  inviteCode   Int? // invite code to join pool
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  wallet       Wallets?
  participants Participants[] // accepted members
  owner        User           @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  createdBy    String
  Transaction  Transaction[]
  Invitation   Invitation[]

  @@index([id, nom])
}

model Transaction {
  id        String       @id @default(uuid())
  amount    Decimal
  senderId  String
  tour      Int
  tontineId String
  tontine   Tontine      @relation(fields: [tontineId], references: [id])
  sender    Participants @relation(fields: [senderId], references: [id], onDelete: Cascade)
  createdAt DateTime     @default(now())
}

// Wallet Model
model Wallets {
  accountNumber String   @id @unique @default(uuid())
  amount        Int
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  tontine       Tontine  @relation(fields: [tontineId], references: [id], onDelete: Cascade)
  tontineId     String   @unique

  @@index([accountNumber])
}

// PoolMembers Model
model Invitation {
  id        String        @id @unique @default(uuid())
  status    InvitedStatus @default(PENDING)
  msisdn    String
  nom       String
  round     Int
  memberId  String?       @unique
  tontine   Tontine       @relation(fields: [tontineId], references: [id], onDelete: Cascade)
  tontineId String

  User User[]
}

enum InvitedStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum Frequence {
  Month
  Week
  Day
}

enum TontineStatus {
  Pending
  Ongoing
  Ended
}

enum TransactionStatus {
  Pending
  Success
  Failed
}
